# Proxy-agent 用户使用指南

> 本指南面向普通用户，帮助您快速上手使用本脚本。即使您没有专业的计算机和网络知识，只要按照本指南一步步操作，也能顺利完成配置。

---

## 目录

1. [开始之前](#开始之前)
2. [安装脚本](#安装脚本)
3. [首次安装代理服务](#首次安装代理服务)
4. [查看账号信息](#查看账号信息)
5. [用户管理](#用户管理)
6. [链式代理详解](#链式代理详解)
7. [外部节点管理](#外部节点管理)
8. [常用功能速查](#常用功能速查)
9. [故障排查指南](#故障排查指南)
10. [常见问题解答](#常见问题解答)

---

## 开始之前

### 您需要准备什么

| 准备项目 | 说明 |
|---------|------|
| **一台 VPS 服务器** | 需要有 root 权限（管理员权限） |
| **SSH 连接工具** | Windows 推荐 PuTTY、Xshell；Mac/Linux 使用自带终端 |
| **域名**（可选） | 如果需要使用 TLS 加密协议，需要一个指向您 VPS IP 的域名 |

### 支持的系统

- Ubuntu 16.04+
- Debian 9+
- CentOS 7+
- 其他主流 Linux 发行版

### 重要提示

- 本脚本需要以 **root 用户** 运行
- 首次安装前，建议使用一台 **干净的 VPS**（未安装过其他代理软件）
- 如果之前安装过其他代理脚本，建议先卸载或重装系统

---

## 安装脚本

### 第一步：连接到您的服务器

使用 SSH 工具连接到您的 VPS，确保您是以 root 用户登录。

如果您使用普通用户登录，可以执行以下命令切换到 root：
```bash
sudo -i
```

### 第二步：下载并运行安装脚本

复制以下命令，粘贴到终端中并回车执行：

```bash
wget -P /root -N https://raw.githubusercontent.com/Lynthar/Proxy-agent/master/install.sh && chmod 700 /root/install.sh && /root/install.sh
```

> **网络问题？** 如果下载失败，可能是您的服务器无法访问 GitHub。可以尝试使用加速镜像或手动上传脚本文件。

### 第三步：以后如何打开脚本

安装完成后，任何时候只需输入以下命令即可打开脚本菜单：

```bash
pasly
```

---

## 首次安装代理服务

运行 `pasly` 后，您会看到主菜单。选择 **选项 1（安装）** 开始安装。

### 安装流程概述

```
┌─────────────────────────────────────────────────────────┐
│  选择内核 → 输入域名 → 申请证书 → 配置协议 → 生成账号  │
└─────────────────────────────────────────────────────────┘
```

### 详细步骤

#### 步骤 1：选择内核

```
请选择核心安装
1. Xray-core
2. sing-box
```

**如何选择？**
- **Xray-core**：功能全面，协议支持丰富，推荐大多数用户使用
- **sing-box**：较新的内核，性能优秀，配置更简洁

> 如果您不确定，选择 **1. Xray-core** 即可。

#### 步骤 2：输入域名

```
请输入域名
例如：www.example.com
```

**注意事项：**
- 域名必须已经解析到您的 VPS IP 地址
- 解析生效可能需要几分钟到几小时不等
- 如果没有域名，部分协议（如 REALITY）不需要域名也可使用

**如何检查域名是否生效？**

脚本会自动检测，如果看到类似提示：
```
当前 VPS IP：1.2.3.4
域名解析 IP：1.2.3.4
```
两个 IP 一致即可继续。

#### 步骤 3：申请 TLS 证书

脚本会自动使用 Let's Encrypt 申请免费证书。

首次申请需要输入邮箱地址（用于接收证书过期提醒）：
```
请输入邮箱地址
```

> 证书有效期 90 天，脚本会自动续期，无需手动操作。

#### 步骤 4：等待安装完成

安装过程会显示进度：
```
进度 1/12：检测安装环境
进度 2/12：安装工具
...
进度 12/12：生成账号
```

#### 步骤 5：记录账号信息

安装完成后，脚本会显示您的账号信息，包括：
- 连接地址和端口
- 各协议的配置参数
- 订阅链接
- 二维码（可用手机扫描）

> **重要**：建议截图或复制保存这些信息！

---

## 查看账号信息

如果您需要再次查看账号信息：

1. 运行 `pasly` 打开菜单
2. 选择 **7. 用户管理**
3. 选择 **1. 查看账号**

系统会显示所有已安装协议的账号信息。

### 查看订阅链接

1. 运行 `pasly` 打开菜单
2. 选择 **7. 用户管理**
3. 选择 **2. 查看订阅**

订阅链接可以导入支持订阅的客户端（如 Clash、V2rayN 等），实现一键配置。

---

## 用户管理

### 添加新用户

1. 选择 **7. 用户管理** → **4. 添加用户**
2. 输入要添加的用户数量
3. 可选：自定义 UUID 和用户名（直接回车使用随机值）

新用户会被添加到所有已安装的协议中。

### 删除用户

1. 选择 **7. 用户管理** → **5. 删除用户**
2. 查看用户列表，输入要删除的用户编号
3. 确认删除

> 注意：每次只能删除一个用户。

---

## 链式代理详解

链式代理是本脚本的高级功能，可以实现多跳代理（流量经过多台服务器转发），常见用途：
- 隐藏真实出口 IP
- 利用不同地区的服务器优势（线路机+落地机）
- 实现分流（不同网站走不同出口）

### 基本概念

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  您的    │ → │  入口    │ → │  中继    │ → │  出口    │ → 互联网
│  设备    │    │  节点    │    │ (可选)   │    │  节点    │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
```

- **入口节点**：您的设备直接连接的服务器
- **中继节点**（可选）：中间转发节点，可以有多个
- **出口节点**：最终连接互联网的服务器

### 进入链式代理菜单

1. 运行 `pasly`
2. 选择 **3. 链式代理管理**

您会看到：
```
链式代理管理
================================================
1. 快速配置向导 [推荐]
2. 查看链式状态
3. 测试链式连接
4. 高级设置
5. 卸载链式代理
6. 外部节点管理
```

### 场景一：配置出口节点（落地机）

**适用情况**：您有一台落地机，想让它作为出口节点。

1. 在落地机上运行 `pasly`
2. 进入 **3. 链式代理管理** → **1. 快速配置向导**
3. 选择 **1. 配置为出口节点**

配置过程：
```
请输入端口 [回车随机生成]:
```
直接回车即可使用随机端口。

```
是否限制仅允许指定入口节点连接? [y/n]
```
- 输入 `y`：更安全，只有指定的入口节点可以连接
- 输入 `n`：任何知道配置的节点都可以连接

配置完成后，脚本会显示一段 **配置代码**，类似：
```
=================================================
出口节点配置代码（请复制并保存）:
CHAIN_EXIT|1.2.3.4|12345|abc123xyz|2022-blake3-aes-128-gcm
=================================================
```

> **重要**：请完整复制这段配置代码，稍后在入口节点配置时需要使用。

### 场景二：配置入口节点（单链路模式）

**适用情况**：您有一台入口机，想连接到一个出口节点。

1. 在入口机上运行 `pasly`
2. 进入 **3. 链式代理管理** → **1. 快速配置向导**
3. 选择 **3. 配置为入口节点 - 单链路模式**

配置过程：
```
请粘贴出口节点配置代码:
```
粘贴之前在出口节点获取的配置代码，回车确认。

脚本会自动解析并显示配置信息：
```
服务器地址: 1.2.3.4
端口: 12345
加密方式: 2022-blake3-aes-128-gcm
```

确认无误后，脚本会自动配置并重启服务。

### 场景三：多链路分流模式

**适用情况**：您想让不同的网站走不同的出口节点。

例如：
- 观看 Netflix → 走美国出口
- 使用 ChatGPT → 走日本出口
- 其他网站 → 走默认出口

#### 配置步骤

1. 在入口机上运行 `pasly`
2. 进入 **3. 链式代理管理** → **1. 快速配置向导**
3. 选择 **4. 配置为入口节点 - 多链路分流模式**

#### 添加第一条链路

```
添加链路 #1
请选择添加方式:
1. 使用配置代码添加（自建出口节点）
2. 使用外部节点添加（第三方节点）
```

**使用配置代码**：粘贴出口节点生成的配置代码

**使用外部节点**：选择已添加的外部节点（见[外部节点管理](#外部节点管理)）

```
请输入链路名称 [默认: chain_1]:
```
建议使用有意义的名称，如 `us_netflix`、`jp_ai` 等。

#### 配置分流规则

```
请选择要分流到此链路的流量类型:
1. 流媒体 (Netflix/Disney+/YouTube/...)
2. AI服务 (OpenAI/Bing/...)
3. 社交媒体 (Telegram/Twitter/...)
4. 开发者 (GitHub/GitLab/...)
5. 游戏 (Steam/Epic/...)
6. Google服务
7. 自定义域名规则
8. 跳过，不配置分流
```

选择对应数字，即可将该类流量分流到此链路。

#### 继续添加更多链路

```
是否继续添加链路? [y/n]
```
输入 `y` 继续添加，输入 `n` 完成配置。

#### 设置默认链路

```
请选择默认链路（未匹配规则的流量将走默认链路）:
1. chain_us
2. chain_jp
3. direct (直连，不经过任何出口)
```

### 查看链式状态

配置完成后，可以随时查看当前链式代理状态：

1. 进入 **3. 链式代理管理** → **2. 查看链式状态**

显示内容包括：
- 已配置的链路数量
- 每条链路的出口信息
- 分流规则配置
- 默认链路

### 测试链式连接

验证链式代理是否正常工作：

1. 进入 **3. 链式代理管理** → **3. 测试链式连接**

测试结果示例：
```
✅ chain_us (1.2.3.4:12345) - 延迟: 150ms
✅ chain_jp (5.6.7.8:23456) - 延迟: 80ms
❌ chain_hk (9.10.11.12:34567) - 连接失败
```

如果显示连接失败，请检查：
- 出口节点是否在线
- 防火墙是否开放对应端口
- 配置代码是否正确

---

## 外部节点管理

外部节点功能允许您使用第三方提供的节点（如购买的机场节点、朋友分享的节点）作为链式代理的出口。

### 支持的协议

- Shadowsocks (SS)
- Shadowsocks 2022 (SS2022)
- SOCKS5
- Trojan

### 添加外部节点

1. 进入 **3. 链式代理管理** → **6. 外部节点管理**
2. 选择 **1. 通过链接添加节点**

支持的链接格式：
```
ss://...           (Shadowsocks)
trojan://...       (Trojan)
socks5://...       (SOCKS5)
```

粘贴链接后，脚本会自动解析并显示节点信息：
```
协议: Shadowsocks
服务器: example.com
端口: 8388
加密方式: aes-256-gcm
节点名称: 美国节点
```

确认添加后，该节点就可以在多链路分流中使用了。

### 手动添加节点

如果没有链接，也可以手动输入：

1. 选择 **2. 手动添加节点**
2. 选择协议类型
3. 依次输入服务器地址、端口、密码等信息

### 测试节点连接

1. 选择 **4. 测试节点连接**
2. 选择要测试的节点

测试结果：
```
✅ TCP连接成功 - 美国节点 (example.com:8388)
```

### 将外部节点设为出口

1. 选择 **5. 设为链式代理出口**
2. 选择要使用的节点
3. 按提示配置分流规则

---

## 常用功能速查

| 功能 | 菜单路径 |
|------|---------|
| 查看账号 | 7 → 1 |
| 查看订阅 | 7 → 2 |
| 添加用户 | 7 → 4 |
| 删除用户 | 7 → 5 |
| 启动服务 | 16 → 选择内核 → 启动 |
| 停止服务 | 16 → 选择内核 → 停止 |
| 重启服务 | 16 → 选择内核 → 重启 |
| 查看日志 | 16 → 选择内核 → 查看日志 |
| 更新脚本 | 17 |
| 回滚脚本 | 22 → 2 |
| 续期证书 | 9 → 2 |
| 切换语言 | 21 |
| 卸载脚本 | 20 |

---

## 故障排查指南

### 服务无法启动

**现象**：执行启动命令后，服务状态显示未运行。

**排查步骤**：

1. **查看日志**
   - 进入 **16. 核心管理** → 选择对应内核 → **查看日志**
   - 查找包含 `error`、`failed`、`invalid` 的行

2. **常见原因及解决方法**

   | 日志关键词 | 可能原因 | 解决方法 |
   |-----------|---------|---------|
   | `port already in use` | 端口被占用 | 更换端口或停止占用该端口的程序 |
   | `certificate` | 证书问题 | 重新申请证书（菜单 9） |
   | `permission denied` | 权限不足 | 确保以 root 用户运行 |
   | `config error` | 配置文件错误 | 检查配置或重新安装 |

3. **手动启动查看详细错误**
   ```bash
   # Xray
   /etc/Proxy-agent/xray/xray -c /etc/Proxy-agent/xray/conf/config.json

   # sing-box
   /etc/Proxy-agent/sing-box/sing-box run -c /etc/Proxy-agent/sing-box/conf/config.json
   ```

### 无法连接代理

**现象**：客户端配置正确，但无法连接。

**排查步骤**：

1. **检查服务状态**
   ```bash
   # Xray
   systemctl status xray

   # sing-box
   systemctl status sing-box
   ```

2. **检查端口是否开放**
   ```bash
   # 检查端口是否监听
   ss -tlnp | grep 端口号

   # 检查防火墙
   ufw status        # Ubuntu
   firewall-cmd --list-all  # CentOS
   ```

3. **检查域名解析**
   ```bash
   ping 您的域名
   ```
   确保解析的 IP 是您的 VPS IP。

4. **检查证书有效期**
   - 进入 **9. 证书管理**
   - 查看证书剩余天数

### 证书申请失败

**现象**：安装过程中证书申请步骤失败。

**常见原因**：

1. **域名未正确解析**
   - 确保域名 A 记录指向 VPS IP
   - 等待 DNS 生效（可能需要几分钟）

2. **80/443 端口被占用**
   ```bash
   # 检查端口占用
   ss -tlnp | grep -E ':80|:443'

   # 如果被 nginx 占用，先停止
   systemctl stop nginx
   ```

3. **申请次数超限**
   - Let's Encrypt 每周每域名限制 5 次
   - 等待一周后重试，或使用 DNS API 方式

4. **使用 DNS API 方式申请**（推荐）
   - 进入 **9. 证书管理** → **3. 使用 DNS API 申请**
   - 支持 Cloudflare、阿里云等

### 链式代理不工作

**现象**：配置了链式代理，但流量未经过出口节点。

**排查步骤**：

1. **检查出口节点状态**
   - 在出口节点服务器上检查服务是否运行
   - 检查防火墙是否开放配置的端口

2. **测试链式连接**
   - 进入 **3. 链式代理管理** → **3. 测试链式连接**

3. **检查配置代码**
   - 确保配置代码完整复制，没有多余空格
   - 重新配置一次

4. **查看入口节点日志**
   - 查找是否有连接出口节点失败的错误

### 速度很慢

**排查方向**：

1. **检查线路质量**
   ```bash
   # 测试到出口节点的延迟
   ping 出口节点IP

   # 测试丢包率
   mtr 出口节点IP
   ```

2. **检查服务器负载**
   ```bash
   top
   ```
   如果 CPU 使用率很高，可能需要升级配置。

3. **启用 BBR**
   - 进入 **18. 安装BBR/DD脚本**
   - 安装 BBR 可以提升 TCP 传输效率

4. **检查协议选择**
   - UDP 协议（Hysteria2、TUIC）通常更快
   - 可以尝试不同协议

---

## 常见问题解答

### Q: 可以同时安装多个协议吗？

**A**: 可以。使用 **2. 自定义组合安装** 可以选择安装多个协议。安装后，所有协议共享同一用户列表。

### Q: 如何更换端口？

**A**: 进入 **12. 添加新端口**，可以为现有协议添加新的监听端口。

### Q: 域名必须要用吗？

**A**: 不一定。以下协议不需要域名：
- VLESS + Reality
- Hysteria2（可以使用自签证书）
- TUIC（可以使用自签证书）

但使用 TLS 的协议（VLESS WS、VMess WS、Trojan 等）需要域名。

### Q: 支持使用宝塔面板吗？

**A**: 支持。脚本会自动检测宝塔面板并调整配置，避免端口冲突。但建议在干净系统上安装以获得最佳体验。

### Q: 如何备份配置？

**A**: 重要配置文件位于 `/etc/Proxy-agent/` 目录。可以定期备份此目录：
```bash
tar -czvf proxy-backup.tar.gz /etc/Proxy-agent/
```

### Q: 忘记了账号信息怎么办？

**A**: 运行 `pasly`，选择 **7. 用户管理** → **1. 查看账号**，即可再次查看所有账号信息。

### Q: 如何彻底卸载？

**A**:
1. 运行 `pasly`
2. 选择 **20. 卸载脚本**
3. 确认卸载

卸载后，所有配置和数据将被删除。

### Q: 更新脚本会影响现有配置吗？

**A**: 不会。更新脚本只更新脚本本身，不会修改已有的代理服务配置。如果担心兼容性问题，可以先使用 **22. 脚本版本管理** 备份当前版本。

### Q: 链式代理和普通代理有什么区别？

**A**:
- **普通代理**：您的设备 → 代理服务器 → 互联网
- **链式代理**：您的设备 → 入口节点 → （中继节点）→ 出口节点 → 互联网

链式代理可以隐藏真实出口 IP，或利用不同服务器的线路优势。

### Q: 外部节点是什么意思？

**A**: 外部节点是指您没有 root 权限的第三方节点，比如：
- 购买的机场节点
- 朋友分享的节点
- 与他人合租的 VPS 上的节点

您只有节点的连接信息（服务器、端口、密码等），可以将其作为链式代理的出口使用。

---

## 快捷命令参考

| 命令 | 功能 |
|------|------|
| `pasly` | 打开脚本菜单 |
| `systemctl status xray` | 查看 Xray 服务状态 |
| `systemctl status sing-box` | 查看 sing-box 服务状态 |
| `systemctl restart xray` | 重启 Xray 服务 |
| `systemctl restart sing-box` | 重启 sing-box 服务 |
| `tail -f /etc/Proxy-agent/xray/access.log` | 实时查看 Xray 访问日志 |
| `tail -f /etc/Proxy-agent/sing-box/conf/box.log` | 实时查看 sing-box 日志 |

---

## 获取帮助

如果您遇到本指南无法解决的问题：

1. **查看项目 GitHub**：https://github.com/Lynthar/Proxy-agent
2. **提交 Issue**：在 GitHub 上描述您的问题
3. **查看日志**：大多数问题都可以通过查看日志找到原因

---

*本指南最后更新时间：2024年*
